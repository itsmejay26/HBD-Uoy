<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no" />
<title>üéµ Music Player</title>
<style>
/* (keep your same styling, unchanged) */
*{margin:0;padding:0;box-sizing:border-box}
body{min-height:100vh;background:linear-gradient(135deg,#D4E6C3 0%,#B5D4A3 50%,#9BC484 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;overflow:hidden;position:relative;padding:20px}
.back-btn{position:fixed;top:20px;left:20px;background:rgba(255,255,255,0.9);border:none;width:50px;height:50px;border-radius:50%;font-size:1.5rem;cursor:pointer;box-shadow:0 5px 20px rgba(0,0,0,0.15);transition:all .3s;z-index:100;display:flex;align-items:center;justify-content:center}
.player-container{background:rgba(255,255,255,0.95);border-radius:30px;padding:40px 30px;width:100%;max-width:350px;box-shadow:0 20px 60px rgba(45,90,39,.3);text-align:center;opacity:0;transform:translateY(30px);animation:fadeUp .8s .3s forwards}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
.album-art{width:200px;height:200px;margin:0 auto 30px;border-radius:50%;background:linear-gradient(135deg,#A8E6CF 0%,#7BC89C 50%,#5BA37A 100%);display:flex;align-items:center;justify-content:center;font-size:5rem;box-shadow:0 10px 40px rgba(45,90,39,.3),inset 0 -5px 20px rgba(0,0,0,.1);position:relative;transition:transform .3s}
.album-art.playing{animation:spin 20s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.song-title{font-size:1.5rem;color:#2D5A27;font-weight:bold;margin-bottom:5px}
.song-artist{font-size:1rem;color:#7BC89C;margin-bottom:30px}
.progress-container{width:100%;margin-bottom:20px}
.progress-bar{width:100%;height:6px;background:#E8F5E9;border-radius:3px;cursor:pointer;position:relative;overflow:hidden}
.progress{height:100%;background:linear-gradient(90deg,#7BC89C 0%,#5BA37A 100%);border-radius:3px;width:0%;transition:width .1s linear}
.time-display{display:flex;justify-content:space-between;font-size:.8rem;color:#7BC89C;margin-top:8px}
.controls{display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:30px}
.control-btn{background:none;border:none;font-size:1.8rem;cursor:pointer;color:#5BA37A;transition:all .3s;padding:10px}
.play-btn{width:70px;height:70px;background:linear-gradient(135deg,#7BC89C 0%,#5BA37A 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff;box-shadow:0 5px 20px rgba(91,163,122,.4)}
.volume-container{display:flex;align-items:center;justify-content:center;gap:10px}
.volume-slider{width:120px;height:6px;-webkit-appearance:none;appearance:none;background:#E8F5E9;border-radius:3px;outline:none}
.visualizer{display:flex;align-items:flex-end;justify-content:center;gap:4px;height:40px;margin-top:20px}
.viz-bar{width:6px;background:linear-gradient(to top,#7BC89C 0%,#A8E6CF 100%);border-radius:3px;transition:height .1s}
.floating-notes{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;overflow:hidden}
.note{position:absolute;font-size:2rem;opacity:0;animation:float-note 4s forwards}
@keyframes float-note{0%{opacity:0;transform:translateY(0) rotate(0deg) scale(0)}20%{opacity:.7;transform:translateY(-20vh) rotate(20deg) scale(1)}100%{opacity:0;transform:translateY(-100vh) rotate(40deg) scale(.5)}}
</style>
</head>
<body>
<button class="back-btn" onclick="goBack()">‚Üê</button>
<div class="floating-notes" id="floatingNotes"></div>

<div class="player-container">
  <div class="album-art" id="albumArt">üéµ</div>
  <div class="song-title">Vienna</div>
  <div class="song-artist">A Special Song For You</div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"><div class="progress" id="progress"></div></div>
    <div class="time-display"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
  </div>

  <div class="controls">
    <button class="control-btn" onclick="rewind()">‚èÆ</button>
    <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="control-btn" onclick="forward()">‚è≠</button>
  </div>

  <div class="volume-container">
    <span class="volume-icon">üîà</span>
    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
    <span class="volume-icon">üîä</span>
  </div>

  <div class="visualizer" id="visualizer"></div>
</div>

<script>
/*
  Approach:
   - Use BroadcastChannel 'music_channel' to control a background player (player.html).
   - On Play: open a named tab window (bgMusicPlayer). On mobile, this opens a new tab which tends to remain alive.
   - If window.open is blocked, fallback to creating a hidden iframe (same origin).
   - Sync UI state with background via BroadcastChannel and localStorage.
*/

const playBtn = document.getElementById('playBtn');
const albumArt = document.getElementById('albumArt');
const progress = document.getElementById('progress');
const progressBar = document.getElementById('progressBar');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');
const volumeSlider = document.getElementById('volumeSlider');
const visualizer = document.getElementById('visualizer');
const floatingNotes = document.getElementById('floatingNotes');

const channelSupported = 'BroadcastChannel' in window;
const channel = channelSupported ? new BroadcastChannel('music_channel') : null;

// create visualizer bars
for (let i=0;i<20;i++){
  const b=document.createElement('div'); b.className='viz-bar'; b.style.height='5px'; visualizer.appendChild(b);
}
const vizBars = document.querySelectorAll('.viz-bar');

let vizInterval, notesInterval;
function startVisualizer(){ if (vizInterval) return; vizInterval=setInterval(()=>{vizBars.forEach(b=>b.style.height=(Math.random()*35+5)+'px')},100) }
function stopVisualizer(){ clearInterval(vizInterval); vizInterval=null; vizBars.forEach(b=>b.style.height='5px') }
function startFloatingNotes(){ if (notesInterval) return; const notes=['üéµ','üé∂','‚ô™','‚ô´','üíö']; notesInterval=setInterval(()=>{const n=document.createElement('div'); n.className='note'; n.textContent=notes[Math.floor(Math.random()*notes.length)]; n.style.left=Math.random()*100+'%'; n.style.bottom='10%'; floatingNotes.appendChild(n); setTimeout(()=>n.remove(),4000);},500) }
function stopFloatingNotes(){ clearInterval(notesInterval); notesInterval=null }

function setUIPlaying(isPlaying){
  if(isPlaying){ playBtn.textContent='‚è∏'; albumArt.classList.add('playing'); startVisualizer(); startFloatingNotes() }
  else { playBtn.textContent='‚ñ∂'; albumArt.classList.remove('playing'); stopVisualizer(); stopFloatingNotes() }
}

// Initialize UI from localStorage
window.addEventListener('load', () => {
  const playing = localStorage.getItem('musicPlaying') === 'true';
  const time = parseFloat(localStorage.getItem('musicTime') || '0') || 0;
  const vol = parseFloat(localStorage.getItem('musicVolume') || '1');
  durationEl.textContent = localStorage.getItem('musicDuration') || '0:00';
  currentTimeEl.textContent = formatTime(time);
  volumeSlider.value = vol;
  if (playing) setUIPlaying(true);
});

// Format time helper
function formatTime(sec){
  if(!isFinite(sec) || isNaN(sec)) return '0:00';
  const m=Math.floor(sec/60), s=Math.floor(sec%60);
  return `${m}:${s.toString().padStart(2,'0')}`;
}

// Request background player to play/pause/seek through BroadcastChannel or postMessage fallback
function ensureBackgroundOpenAndSend(action, payload){
  // try to open named tab (works better on mobile than popup windows)
  try {
    const bg = window.open('/player.html?bg=1', 'bgMusicPlayer'); // reuses same named tab if exists
    // send via BroadcastChannel
    if (channel) channel.postMessage(Object.assign({action}, payload||{}));
    else {
      // fallback: postMessage directly to opened window if available
      if (bg && !bg.closed) bg.postMessage(Object.assign({action}, payload||{}), location.origin);
    }
    // record that background window should be open
    localStorage.setItem('bgWindowOpen','true');
  } catch(e){
    // window.open blocked ‚Äî fallback to injecting a hidden iframe (same-origin)
    let iframe = document.getElementById('bgPlayerIframe');
    if (!iframe){
      iframe = document.createElement('iframe');
      iframe.id = 'bgPlayerIframe';
      iframe.style.display = 'none';
      iframe.src = '/player.html?embed=1';
      document.body.appendChild(iframe);
      // small delay to let iframe load
      setTimeout(()=> {
        if (channel) channel.postMessage(Object.assign({action}, payload||{}));
        else iframe.contentWindow?.postMessage(Object.assign({action}, payload||{}), location.origin);
      }, 600);
    } else {
      if (channel) channel.postMessage(Object.assign({action}, payload||{}));
      else iframe.contentWindow?.postMessage(Object.assign({action}, payload||{}), location.origin);
    }
    localStorage.setItem('bgWindowOpen','true');
  }
}

// Play/Pause toggle (user gesture)
function togglePlay(){
  const currentlyShowingPlaying = playBtn.textContent === '‚è∏';
  if (currentlyShowingPlaying){
    ensureBackgroundOpenAndSend('pause');
    setUIPlaying(false);
    localStorage.setItem('musicPlaying','false');
  } else {
    const desiredTime = parseFloat(localStorage.getItem('musicTime') || '0');
    ensureBackgroundOpenAndSend('play',{time: desiredTime});
    setUIPlaying(true);
    localStorage.setItem('musicPlaying','true');
  }
}

// Rewind/Forward
function rewind(){ ensureBackgroundOpenAndSend('seek',{time: Math.max(0,(parseFloat(localStorage.getItem('musicTime')||'0')-10))}) }
function forward(){ ensureBackgroundOpenAndSend('seek',{time: (parseFloat(localStorage.getItem('musicTime')||'0')+10)}) }

// Volume slider
volumeSlider.addEventListener('input', (e) => {
  const vol = parseFloat(e.target.value);
  localStorage.setItem('musicVolume', vol.toString());
  if (channel) channel.postMessage({action:'volume', volume:vol});
  else {
    const bg = window.open('/player.html?bg=1','bgMusicPlayer');
    if (bg && !bg.closed) bg.postMessage({action:'volume', volume:vol}, location.origin);
    const iframe=document.getElementById('bgPlayerIframe');
    if (iframe) iframe.contentWindow?.postMessage({action:'volume', volume:vol}, location.origin);
  }
});

// Progress bar click -> send seek
progressBar.addEventListener('click', (e)=>{
  // we don't know duration on main page reliably, send percent request to background
  const rect = progressBar.getBoundingClientRect();
  const pct = (e.clientX - rect.left)/rect.width;
  if (channel) channel.postMessage({action:'seekPercent', percent:pct});
  else {
    const bg = window.open('/player.html?bg=1','bgMusicPlayer');
    if (bg && !bg.closed) bg.postMessage({action:'seekPercent', percent:pct}, location.origin);
    const iframe=document.getElementById('bgPlayerIframe');
    if (iframe) iframe.contentWindow?.postMessage({action:'seekPercent', percent:pct}, location.origin);
  }
});

// Listen for updates from background player
if (channel) {
  channel.addEventListener('message', (ev)=>{
    const msg = ev.data || {};
    if (!msg.action) return;
    if (msg.action === 'state') {
      // {playing, time, duration}
      if (typeof msg.playing === 'boolean') setUIPlaying(msg.playing);
      if (typeof msg.time === 'number') currentTimeEl.textContent = formatTime(msg.time);
      if (typeof msg.duration === 'number') durationEl.textContent = formatTime(msg.duration);
      if (typeof msg.progressPercent === 'number') progress.style.width = (msg.progressPercent*100)+'%';
      // keep local storage updated
      if (typeof msg.time === 'number') localStorage.setItem('musicTime', msg.time);
      if (typeof msg.duration === 'number') localStorage.setItem('musicDuration', formatTime(msg.duration));
    } else if (msg.action === 'volume') {
      if (typeof msg.volume === 'number') volumeSlider.value = msg.volume;
    }
  });
} else {
  // fallback window message listener
  window.addEventListener('message', (ev)=>{
    try { if (ev.origin !== location.origin) return; } catch(e){}
    const msg = ev.data || {};
    if (!msg.action) return;
    if (msg.action === 'state') {
      if (typeof msg.playing === 'boolean') setUIPlaying(msg.playing);
      if (typeof msg.time === 'number') currentTimeEl.textContent = formatTime(msg.time);
      if (typeof msg.duration === 'number') durationEl.textContent = formatTime(msg.duration);
      if (typeof msg.progressPercent === 'number') progress.style.width = (msg.progressPercent*100)+'%';
      if (typeof msg.time === 'number') localStorage.setItem('musicTime', msg.time);
      if (typeof msg.duration === 'number') localStorage.setItem('musicDuration', formatTime(msg.duration));
    } else if (msg.action === 'volume') {
      if (typeof msg.volume === 'number') volumeSlider.value = msg.volume;
    }
  });
}

// Save state before leaving
window.addEventListener('beforeunload', ()=> {
  // keep musicPlaying/musicTime stored so background can pick up
  // we do not pause here; background tab is responsible for playback
  localStorage.setItem('musicTime', localStorage.getItem('musicTime') || '0');
});

function goBack(){
  // navigation; keep music playing
  window.location.href = 'next-page.html';
}
</script>
</body>
</html>
